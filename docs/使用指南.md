# Portfolio Selection 使用指南

**投资组合优化系统 - 完整使用手册**

---

## 🚀 快速开始

### 一键运行

```bash
# 1. 进入项目目录
cd /Users/zp/Desktop/cource_assignment

# 2. 激活conda环境
conda activate cource_work

# 3. 运行主程序
python main.py
```

**⚠️ 重要提示**：
- **首次运行需要开启全局代理**（用于访问Yahoo Finance获取数据）
- 确保网络连接正常，能访问国际网站
- 如已有数据文件，可跳过数据获取步骤（无需代理）

**首次运行时间**：约30秒（含数据获取）  
**后续运行时间**：约10秒（使用100个mu值）

---

## 📋 项目概况

### 基本信息

- **研究对象**：Portfolio Selection（投资组合选择）
- **参考教材**：Robert J. Vanderbei - Linear Programming (2020 5th) 第13章
- **实现工具**：Python + PuLP + CBC求解器
- **数据来源**：Yahoo Finance真实市场数据
- **投资标的**：9个ETF（SHY, XLB, XLE, XLF, XLI, XLK, XLP, XLU, XLV）
- **数据周期**：36个月（2022.11 - 2025.10）

### 核心成果

- ✅ **100个最优投资组合**（完整有效前沿）
- ✅ **5张专业图表**（300 DPI高清）
- ✅ **详细分析报告**
- ✅ **完整源代码**（约1140行）

---

## 📁 项目结构

```
cource_assignment/
├── README.md                          # 项目简介
├── main.py                            # 主程序（运行这个）
├── requirements.txt                   # 依赖包列表
│
├── src/                               # 源代码
│   ├── data_fetcher.py               # 数据获取
│   ├── portfolio_model.py            # 优化模型
│   └── visualization.py              # 可视化
│
├── data/                              # 数据
│   ├── raw/price_data.csv            # 原始价格
│   └── processed/monthly_returns.csv # 月度收益率
│
├── results/                           # 结果
│   ├── analysis/
│   │   ├── optimization_results.csv  # 100个优化结果
│   │   └── analysis_report.txt       # 分析报告
│   └── figures/                      # 5张图表
│
├── docs/                              # 文档
│   ├── 使用指南.md                   # 本文件
│   ├── 算法原理.md                   # 技术文档
│   ├── 有效前沿说明.md               # 结果解读
│   ├── PPT大纲.md                    # 演示大纲
│   └── 项目总结.md                   # 完成总结
│
└── Requirements&References/           # 参考资料
    ├── 课程作业一.md                 # 作业要求
    ├── cource_work.md                # 教材原文
    └── 教材第13章_中文翻译.md        # 教材翻译
```

---

## 🎯 核心结果

### 100个最优投资组合

**有效前沿覆盖**：
- mu值范围：0.1 → 31.6
- 收益范围：0.36% → 2.62%（月度）
- 风险范围：0.42% → 4.43%（MAD）

### 代表性组合

#### 1. 最小风险（保守型）
```
mu = 0.10
配置：99.2% SHY（国债） + 0.8% XLE（能源）
月收益：0.36%，年化：4.44%
风险：0.42%
夏普比率：238.91 ⭐⭐⭐⭐⭐
```

#### 2. 平衡组合（稳健型）
```
mu ≈ 1.08
配置：90.4% SHY + 8.0% XLK（科技） + 1.6% XLE
月收益：0.54%，年化：6.72%
风险：0.56%
夏普比率：179.18 ⭐⭐⭐⭐⭐
```

#### 3. 最大收益（激进型）
```
mu ≥ 2.92
配置：100% XLK（科技板块）
月收益：2.62%，年化：36.42%
风险：4.43%
夏普比率：23.19 ⭐⭐
```

### 策略对比

| 策略 | 月收益 | 风险 | 夏普比率 |
|------|--------|------|---------|
| 最小风险优化 | 0.36% | 0.42% | **238.91** |
| 平衡优化 | 0.54% | 0.56% | **179.18** |
| 等权重 | 1.04% | 2.49% | 40.61 |
| 最大收益优化 | 2.62% | 4.43% | 23.19 |

**结论**：优化策略的夏普比率是简单策略的4-10倍！

---

## 📊 生成的文件说明

### 数据文件

1. **data/raw/price_data.csv**
   - 9个ETF的日度价格数据
   - 751个交易日
   - 时间范围：2022-10-30 至 2025-10-29

2. **data/processed/monthly_returns.csv**
   - 月度收益率数据
   - 36个月
   - 格式：R(t) = P(t) / P(t-1)

### 结果文件

3. **results/analysis/optimization_results.csv**
   - **100行优化结果**
   - 每行包含：mu、收益、风险、9个资产的权重
   - 可用Excel/Numbers打开

4. **results/analysis/analysis_report.txt**
   - 详细的文字分析报告
   - 包含数据概况、模型说明、关键组合、主要发现

### 图表文件（全部英文，无字体问题）

5. **efficient_frontier.png** - 有效前沿图
   - 蓝色曲线：100个最优组合
   - 绿色星：最小风险组合
   - 红色星：最大收益组合

6. **weights_evolution.png** - 权重演化图
   - 堆积面积图显示资产配置变化
   - X轴：mu值（对数刻度）
   - Y轴：配置权重

7. **mu_sensitivity.png** - 参数敏感性图
   - 三个子图显示mu对收益、风险、目标函数的影响

8. **strategy_comparison.png** - 策略对比图
   - 左图：收益对比
   - 右图：风险对比

9. **weight_heatmap.png** - 权重热力图
   - 颜色深浅表示配置比例
   - 可见资产配置的演化模式

---

## 🔧 环境配置

### 前置要求

- Python 3.8+
- Conda环境管理器
- 网络连接（首次获取数据）

### 依赖安装

```bash
# 激活环境
conda activate cource_work

# 安装依赖（如果还没安装）
pip install -r requirements.txt
```

**主要依赖包**：
- `yfinance` - 获取金融数据
- `pulp` - 线性规划建模
- `pandas` - 数据处理
- `numpy` - 数值计算
- `matplotlib` - 可视化
- `seaborn` - 高级可视化

---

## 💻 使用方法

### 方法1：运行完整分析

```bash
python main.py
```

程序将自动完成：
1. 数据获取/加载
2. 模型构建
3. 参数化求解（100个mu值）
4. 基准策略计算
5. 可视化生成
6. 报告输出

### 方法2：单独运行模块

#### 数据获取
```bash
cd src
python data_fetcher.py
```

#### 优化求解
```python
from src.portfolio_model import PortfolioOptimizer
import pandas as pd

returns = pd.read_csv('data/processed/monthly_returns.csv', 
                      index_col=0, parse_dates=True)
optimizer = PortfolioOptimizer(returns)

# 求解单个mu值
result = optimizer.solve(mu=5.0)
print(result)

# 参数化求解
results_df = optimizer.solve_parametric()  # 默认100个mu值
```

#### 可视化
```python
from src.visualization import PortfolioVisualizer
import pandas as pd

results_df = pd.read_csv('results/analysis/optimization_results.csv')
asset_names = ['SHY', 'XLB', 'XLE', 'XLF', 'XLI', 'XLK', 'XLP', 'XLU', 'XLV']

viz = PortfolioVisualizer(results_df, asset_names)
viz.plot_all()
```

---

## 📖 数学模型

### 线性规划模型

**目标函数**：
$$\max \quad \mu \sum_{j=1}^9 x_j r_j - \frac{1}{36}\sum_{t=1}^{36} y_t$$

**约束条件**：
$$
\begin{aligned}
-y_t &\leq \sum_{j=1}^9 x_j(R_j(t) - r_j) \leq y_t, \quad t=1,...,36 \\
\sum_{j=1}^9 x_j &= 1 \\
x_j &\geq 0, \quad j=1,...,9 \\
y_t &\geq 0, \quad t=1,...,36
\end{aligned}
$$

**变量说明**：
- $x_j$：资产j的配置比例（决策变量）
- $r_j$：资产j的期望收益
- $y_t$：第t期的绝对偏差（辅助变量）
- $\mu$：风险厌恶参数

**风险度量**：MAD (Mean Absolute Deviation)
$$\text{Risk} = \frac{1}{T}\sum_{t=1}^T |R_p(t) - \mathbb{E}[R_p]|$$

---

## 🔍 常见问题

### Q1: 如何修改投资标的？

编辑 `src/data_fetcher.py`：
```python
self.tickers = ['AAPL', 'GOOGL', 'MSFT', ...]  # 改为你想要的股票
```

### Q2: 如何调整时间范围？

创建DataFetcher时指定：
```python
fetcher = DataFetcher(
    start_date='2020-01-01',
    end_date='2023-12-31'
)
```

### Q3: 如何改变mu值数量？

修改 `main.py`：
```python
# 当前：100个点
mu_values = np.logspace(-1, 1.5, 100)

# 改为：50个点（更快）
mu_values = np.logspace(-1, 1.5, 50)

# 改为：200个点（更精细）
mu_values = np.logspace(-1, 1.5, 200)
```

### Q4: 数据获取失败怎么办？

**常见原因和解决方案**：

1. **网络问题**
   - ⚠️ **开启全局代理**（最重要！）
   - 确保能访问Yahoo Finance
   - 测试：在浏览器访问 https://finance.yahoo.com

2. **限流问题**
   - 增加延时参数（修改`delay=2.5`为更大值，如5秒）
   - 分批获取数据

3. **跳过数据获取**
   - 如已有数据文件，程序会提示是否重新获取
   - 选择"n"直接使用已有数据（无需代理）

4. **手动下载数据**
   - 已提供完整数据文件在GitHub仓库
   - 直接使用预下载的数据

### Q5: 图表中文乱码？

已修复！所有图表都使用英文标签，不会有字体问题。

### Q6: 如何查看某个具体组合？

```python
import pandas as pd

df = pd.read_csv('results/analysis/optimization_results.csv')

# 查看第42个组合（平衡型）
print(df.iloc[41])  # 索引从0开始

# 查找特定mu值的组合
mu_target = 1.0
idx = (df['mu'] - mu_target).abs().idxmin()
print(df.iloc[idx])
```

---

## 🎓 答辩准备

### 核心要点（3分钟说清楚）

1. **问题**：Portfolio Selection - 在风险和收益之间权衡
2. **方法**：线性规划 + MAD风险度量
3. **结果**：100个最优组合构成有效前沿
4. **优势**：优化策略的夏普比率是简单策略的4-10倍

### 可能的问题

**Q: 为什么用MAD而不是方差？**
- MAD可以转化为线性约束，保持LP性质
- 求解速度快（秒级 vs 分钟级）
- 对极端值更鲁棒

**Q: 如何验证模型正确性？**
- 边界情况测试（mu→0和mu→∞）
- 与理论预期对比（有效前沿性质）
- 多重验证（KKT条件、数值稳定性）

**Q: 100个组合够吗？**
- 理论上有无穷多个点
- 100个采样点足以准确刻画有效前沿
- 对数刻度分布保证了全范围覆盖

**Q: 实际应用的局限性？**
- 历史数据不能完全预测未来
- 未考虑交易成本、税收
- 需要定期重新优化（建议每月）
- 应结合市场判断和个人情况

---

## 📖 详细文档

- **算法原理**：`docs/算法原理.md` - 数学推导和实现细节
- **有效前沿说明**：`docs/有效前沿说明.md` - 100个组合的详细解读
- **PPT大纲**：`docs/PPT大纲.md` - 15分钟演示方案
- **项目总结**：`docs/项目总结.md` - 完整成果和提交清单

---

## 🛠️ 技术细节

### 求解性能

| 指标 | 数值 |
|------|------|
| 问题规模 | 45变量 + 73约束 |
| 单次求解 | < 0.1秒 |
| 100次求解 | ~10秒 |
| 内存占用 | < 20MB |

### 数据质量

| 项目 | 说明 |
|------|------|
| 数据源 | Yahoo Finance API |
| 数据点 | 751个交易日 → 36个月 |
| 缺失值 | 已处理（删除） |
| 异常值 | 已检查（无异常） |

---

## 🎬 演示视频建议

### 录制方案（15分钟）

**Part 1: 问题与模型**（5分钟）
- 投资组合选择问题介绍
- 数学模型推导
- LP转化技巧

**Part 2: 代码演示**（5分钟）
```bash
# 展示运行
python main.py

# 展示结果
ls -R results/
open results/figures/efficient_frontier.png
```

**Part 3: 结果分析**（5分钟）
- 有效前沿解读
- 关键组合对比
- 主要发现总结

---

## 📞 技术支持

### 运行问题排查

1. **导入错误**
   ```bash
   pip install -r requirements.txt
   ```

2. **数据获取失败**
   - 检查网络连接
   - 增加延时参数
   - 使用已有数据（跳过获取步骤）

3. **求解器错误**
   - 确保PuLP正确安装
   - CBC求解器会自动下载

4. **图表显示问题**
   - 所有图表都是英文，不会有字体问题
   - 如看不到图片，检查文件路径

---

## 📚 参考文献

1. Vanderbei, R. J. (2020). *Linear Programming: Foundations and Extensions* (5th ed.). Springer. Chapter 13.

2. Konno, H., & Yamazaki, H. (1991). Mean-Absolute Deviation Portfolio Optimization Model. *Management Science*, 37(5), 519-531.

3. Markowitz, H. (1952). Portfolio Selection. *The Journal of Finance*, 7(1), 77-91.

---

**更新时间**：2025年10月29日  
**版本**：v2.0（100个mu值）


