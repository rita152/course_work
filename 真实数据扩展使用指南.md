# 真实数据扩展使用指南

## 🎯 功能概述

本系统已扩展支持从**Yahoo Finance**获取真实的ETF历史数据，您可以：
- ✅ 获取最新的市场数据
- ✅ 对比不同时期的投资策略
- ✅ 验证模型在真实市场的表现
- ✅ 进行时间序列分析

---

## 📦 快速开始

### 步骤1: 确保依赖已安装

```bash
conda activate cource_work
cd /home/zhangpeng/cource_work/portfolio_selection
pip install yfinance
```

### 步骤2: 获取真实数据

```bash
# 运行数据获取脚本
python scripts/fetch_real_data.py
```

选择您感兴趣的时期：

**推荐选项**:
- 选项 **6**: 最近2年 (2022-2023) - 最新市场数据
- 选项 **5**: 疫情期 (2019-2021) - 包含疫情影响
- 选项 **3**: 金融危机 (2007-2009) - 压力测试

### 步骤3: 使用新数据运行分析

修改 `src/main.py` 第39行：

```python
# 原来的
data_path = Path(__file__).parent.parent / "data" / "returns_data.csv"

# 改为（例如使用最近2年数据）
data_path = Path(__file__).parent.parent / "data" / "returns_data_recent_2y.csv"
```

然后运行：
```bash
python src/main.py
```

---

## 📊 预设时间段

| 选项 | 时期 | 月数 | 特点 | 文件名 |
|------|------|------|------|--------|
| 1 | 2005-2007 | 24 | 教材原始，经济增长期 | returns_data_original.csv |
| 2 | 2006-2007 | 24 | 金融危机前，牛市 | returns_data_pre_crisis.csv |
| 3 | 2007-2009 | 36 | 金融危机，极端风险 | returns_data_with_crisis.csv |
| 4 | 2018-2019 | 24 | 疫情前，正常时期 | returns_data_pre_covid.csv |
| 5 | 2019-2021 | 36 | 疫情期，V型反转 | returns_data_with_covid.csv |
| 6 | 2022-2023 | 24 | 最近2年，高通胀期 | returns_data_recent_2y.csv |
| 7 | 2021-2023 | 36 | 最近3年，加息周期 | returns_data_recent_3y.csv |
| 8 | 自定义 | 自定 | 自己指定日期范围 | 自定义名称 |

---

## 🔬 对比分析

### 运行多时期对比

```bash
python scripts/compare_periods.py
```

这会自动：
1. 加载多个时期的数据
2. 对每个时期运行优化
3. 生成对比图表（4个子图）：
   - 有效前沿对比
   - 收益范围对比
   - 风险范围对比
   - 资产表现对比
4. 保存到 `results/period_comparison.png`

---

## 💡 使用场景

### 场景1: 验证模型的时间稳定性

获取不同时期数据，观察：
- 有效前沿是否稳定
- 最优配置是否一致
- μ参数的敏感性变化

**示例**:
```bash
# 获取3个不同时期
python scripts/fetch_real_data.py  # 选6 (2022-2023)
python scripts/fetch_real_data.py  # 选4 (2018-2019)
python scripts/fetch_real_data.py  # 选3 (2007-2009)

# 运行对比
python scripts/compare_periods.py
```

### 场景2: 压力测试

使用包含危机的数据测试模型：

```bash
# 获取金融危机数据
python scripts/fetch_real_data.py  # 选3

# 修改main.py使用该数据
# 观察：
# - 最小风险组合的配置
# - 能源等高风险行业的表现
# - 债券的避险效果
```

### 场景3: 最新市场分析

```bash
# 获取最新数据
python scripts/fetch_real_data.py  # 选6或7

# 分析当前市场特征：
# - 哪些行业表现最好
# - 当前最优投资组合
# - 风险-收益权衡
```

---

## 📈 数据示例

### 获取2022-2023年数据

运行后会看到：

```
======================================================================
开始获取真实金融数据...
======================================================================

数据范围: 2022-01-01 至 2023-12-31
投资标的: SHY, XLB, XLE, XLF, XLI, XLK, XLP, XLU, XLV

正在下载数据...
[*********************100%%**********************]  9 of 9 completed

数据下载完成！
原始数据点数: 504
月度数据点数: 24
有效月度收益率数据: 23

======================================================================
数据统计信息:
======================================================================
       资产    平均收益率        标准差      最小值      最大值  数据点数
      SHY  0.998261  0.012456  0.973618  1.012983        23
      XLB  1.004565  0.046821  0.919474  1.091452        23
      XLE  1.011304  0.070561  0.870126  1.163352        23
      ...

数据已保存到: .../data/returns_data_recent_2y.csv
```

---

## 🔍 数据质量说明

### 优势
✅ 来自Yahoo Finance，权威可靠  
✅ 自动更新，可获取最新数据  
✅ 包含调整后价格（考虑分红等）  
✅ 免费，无需API密钥  

### 注意事项
⚠️ 可能有缺失日期（节假日等）  
⚠️ 极早期数据可能不完整  
⚠️ 需要网络连接  
⚠️ Yahoo Finance有访问频率限制  

---

## 🎓 分析建议

### 1. 对比教材数据vs真实数据

**教材数据 (2005-2007)**:
- 经济增长期
- 能源表现优异
- 风险相对较低

**真实数据 (2022-2023)**:
- 高通胀、加息
- 能源波动加大
- 债券和股票同跌

**结论**: 不同市场环境下，最优策略差异显著

### 2. 识别市场regime变化

通过对比多个时期：
- 牛市: 激进策略效果好
- 熊市: 保守策略更优
- 震荡市: 平衡策略稳健

### 3. 验证分散投资效果

在不同时期验证：
- 分散投资是否降低风险
- 相关性如何变化
- 对冲策略有效性

---

## 📝 高级用法

### 1. 修改投资标的

编辑 `scripts/fetch_real_data.py`：

```python
self.tickers = {
    'SHY': '3-Year Treasury Bond ETF',
    'XLB': 'Materials Sector ETF',
    # 添加新的ETF
    'QQQ': 'NASDAQ-100 ETF',
    'SPY': 'S&P 500 ETF',
    'GLD': 'Gold ETF',
}
```

### 2. 使用不同数据周期

在Python中调用：

```python
from scripts.fetch_real_data import RealDataFetcher

fetcher = RealDataFetcher()

# 周度数据
weekly_data = fetcher.fetch_data(
    '2022-01-01', '2023-12-31', 
    period='weekly'
)

# 日度数据
daily_data = fetcher.fetch_data(
    '2023-01-01', '2023-12-31',
    period='daily'
)
```

### 3. 滚动窗口分析

```python
import pandas as pd
from datetime import datetime, timedelta

# 定义滚动窗口
window_size = 24  # 24个月
step = 6          # 每6个月滚动一次

# 对每个窗口运行优化
# ... (具体实现)
```

---

## 🆚 教材数据 vs 真实数据对比

### 教材数据的价值
- ✅ 稳定，便于教学
- ✅ 时期明确，结果可重现
- ✅ 适合验证模型正确性

### 真实数据的价值
- ✅ 反映当前市场状况
- ✅ 包含最新经济环境
- ✅ 更有实际应用价值
- ✅ 可以发现新的市场规律

### 建议使用策略
1. **学习阶段**: 使用教材数据，确保模型正确
2. **验证阶段**: 用真实历史数据验证
3. **应用阶段**: 用最新数据做实际决策

---

## 🐛 故障排除

### 问题1: 下载失败

```
URLError: <urlopen error [Errno -3] Temporary failure in name resolution>
```

**解决**:
- 检查网络连接
- 稍后重试
- 使用VPN

### 问题2: 数据不完整

某些ticker没有数据

**解决**:
- 检查ticker代码是否正确
- 确认该时期是否有该ETF
- 调整时间范围

### 问题3: 速度慢

**解决**:
- 减少时间跨度
- 减少ticker数量
- 避免频繁请求

---

## 📚 相关文档

- `scripts/README_real_data.md` - 详细技术文档
- `scripts/fetch_real_data.py` - 数据获取脚本
- `scripts/compare_periods.py` - 对比分析脚本
- `README.md` - 项目主文档

---

## ✨ 总结

通过真实数据扩展，您可以：
1. ✅ 验证模型在真实市场的有效性
2. ✅ 分析不同市场环境的投资策略
3. ✅ 进行时间序列和对比研究
4. ✅ 获得更有实际价值的结论

**建议工作流**:
```
教材数据（验证） → 历史数据（回测） → 最新数据（应用）
```

---

**开始探索真实数据的威力吧！** 🚀

